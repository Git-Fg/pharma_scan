{
  "url": "https://drift.simonbinder.eu/dart_api/transactions",
  "markdown": "# Transactions\n[Drift](https://drift.simonbinder.eu/)\n-   [Docs](https://drift.simonbinder.eu/)\n-   [Guides](https://drift.simonbinder.eu/guides/datetime-migrations)\n-   [Examples](https://drift.simonbinder.eu/examples/)\n-   [pub.dev](https://pub.dev/packages/drift)\n-   [Docs](https://drift.simonbinder.eu/)\n    -   -   [Home](https://drift.simonbinder.eu/)\n        -   [Setup guide](https://drift.simonbinder.eu/setup)\n        -   [FAQ](https://drift.simonbinder.eu/faq)\n    -   Dart reference\n        -   [Defining tables](https://drift.simonbinder.eu/dart_api/tables)\n        -   [Selects](https://drift.simonbinder.eu/dart_api/select)\n        -   [Writes (update, insert, delete)](https://drift.simonbinder.eu/dart_api/writes)\n        -   [Expressions](https://drift.simonbinder.eu/dart_api/expressions)\n        -   [Stream queries](https://drift.simonbinder.eu/dart_api/streams)\n        -   [Schema introspection](https://drift.simonbinder.eu/dart_api/schema_inspection)\n        -   [Views](https://drift.simonbinder.eu/dart_api/views)\n        -   [DAOs](https://drift.simonbinder.eu/dart_api/daos)\n        -   [Manager API](https://drift.simonbinder.eu/dart_api/manager)\n        -   [Transactions](https://drift.simonbinder.eu/dart_api/transactions)\n    -   SQL API reference\n        -   [Overview](https://drift.simonbinder.eu/sql_api)\n        -   [Drift files](https://drift.simonbinder.eu/sql_api/drift_files)\n        -   [SQLite extensions](https://drift.simonbinder.eu/sql_api/extensions)\n        -   [Custom queries](https://drift.simonbinder.eu/sql_api/custom_queries)\n    -   Migrations\n        -   [Overview](https://drift.simonbinder.eu/migrations)\n        -   [Migrator APIs](https://drift.simonbinder.eu/migrations/api)\n        -   [Testing](https://drift.simonbinder.eu/migrations/tests)\n        -   [Helpers](https://drift.simonbinder.eu/migrations/step_by_step)\n        -   [Schema exports](https://drift.simonbinder.eu/migrations/exports)\n    -   Platforms\n        -   [Overview](https://drift.simonbinder.eu/platforms)\n        -   [Native](https://drift.simonbinder.eu/platforms/vm)\n        -   [Web](https://drift.simonbinder.eu/platforms/web)\n        -   [Encryption](https://drift.simonbinder.eu/platforms/encryption)\n        -   [libsql](https://drift.simonbinder.eu/platforms/libsql)\n        -   [PostgreSQL](https://drift.simonbinder.eu/platforms/postgres)\n    -   Generation options\n        -   [Overview](https://drift.simonbinder.eu/generation_options)\n        -   [Modular code generation](https://drift.simonbinder.eu/generation_options/modular)\n        -   [Drift and other builders](https://drift.simonbinder.eu/generation_options/in_other_builders)\n    -   Tools\n        -   [Overview](https://drift.simonbinder.eu/tools)\n        -   [Devtools extension](https://drift.simonbinder.eu/tools/devtools)\n        -   [Community tools](https://drift.simonbinder.eu/community_tools)\n    -   Advanced topics\n        -   [Isolates](https://drift.simonbinder.eu/isolates)\n        -   [Testing](https://drift.simonbinder.eu/testing)\n        -   [Generated table rows](https://drift.simonbinder.eu/dart_api/rows)\n        -   [Type converters](https://drift.simonbinder.eu/type_converters)\n        -   [Custom SQL types](https://drift.simonbinder.eu/sql_api/types)\n[Edit this page](https://github.com/simolus3/drift/edit/develop/docs/content/dart_api/transactions.md) [Create documentation issue](https://github.com/simolus3/drift/issues/new?template=docs.md&title=Documentation+issue%3A+Transactions)\nOn this page[](# \"Top of the page\")\n-   [⚠️ Important things to know about transactions](#-important-things-to-know-about-transactions)\n-   [Transactions and query streams](#transactions-and-query-streams)\n-   [Nested transactions](#nested-transactions)\n    -   [Supported implementations](#supported-implementations)\n# Transactions\nRun multiple statements atomically\nDrift has support for transactions and allows multiple statements to run atomically, so that none of their changes is visible to the main database until the transaction is finished. To begin a transaction, call the `transaction` method on your database or a DAO. It takes a function as an argument that will be run transactionally. In the following example, which deals with deleting a category, we move all todo entries in that category back to the default category:\n```\nFuture<void> deleteCategory(Category category) {\n  return transaction(() async {\n    // first, move the affected todo entries back to the default category\n    await (update(todoItems)\n          ..where((row) => row.category.equals(category.id)))\n        .write(const TodoItemsCompanion(category: Value(null)));\n    // then, delete the category\n    await delete(categories).delete(category);\n  });\n}\n```\n## ⚠️ Important things to know about transactions[#](https://drift.simonbinder.eu/dart_api/transactions#-important-things-to-know-about-transactions)\nThere are a couple of things that should be kept in mind when working with transactions:\n1.  **Await all calls**: All queries inside the transaction must be `await`\\-ed. The transaction will complete when the inner method completes. Without `await`, some queries might be operating on the transaction after it has been closed! This can cause data loss or runtime crashes. Drift contains some runtime checks against this misuse and will throw an exception when a transaction is used after being closed. A transaction is active during all asynchronous calls made in a `transaction` block, so transactions also can't schedule timers or other operations using the database (as those would try to use the transaction after the main `transaction` block has completed).\n2.  **Different behavior of stream queries**: Inside a `transaction` callback, stream queries behave differently. If you're creating streams inside a transaction, check the next section to learn how they behave.\n## Transactions and query streams[#](https://drift.simonbinder.eu/dart_api/transactions#transactions-and-query-streams)\nQuery streams that have been created outside a transaction work nicely together with updates made in a transaction: All changes to tables will only be reported after the transaction completes. Updates inside a transaction don't have an immediate effect on streams, so your data will always be consistent and there aren't any unnecessary updates.\nStreams created _inside_ a `transaction` block (or in a function that was called inside a `transaction`) block reflect changes made in a transaction immediately. However, such streams close when the transaction completes.\nThis behavior is useful if you're collapsing streams inside a transaction, for instance by calling `first` or `fold`. However, we recommend that streams created _inside_ a transaction are not listened to _outside_ of a transaction. While it's possible, it defeats the isolation principle of transactions as its state is exposed through the stream.\n## Nested transactions[#](https://drift.simonbinder.eu/dart_api/transactions#nested-transactions)\nStarting from drift version 2.0, it is possible to nest transactions on most implementations. When calling `transaction` again inside a `transaction` block (directly or indirectly through method invocations), a _nested transaction_ is created. Nested transactions behave as follows:\n-   When they start, queries issued in a nested transaction see the state of the database from the outer transaction immediately before the nested transaction was started.\n-   Writes made by a nested transaction are only visible inside the nested transaction at first. The outer transaction and the top-level database don't see them right away, and their stream queries are not updated.\n-   When a nested transaction completes successfully, the outer transaction sees the changes made by the nested transaction as an atomic write (stream queries created in the outer transaction are updated once).\n-   When a nested transaction throws an exception, it is reverted (so in that sense, it behaves just like other transactions). The outer transaction can catch this exception, after it will be in the same state before the nested transaction was started. If it does not catch that exception, it will bubble up and revert that transaction as well.\nThe following snippet illustrates the behavior of nested transactions:\n```\nFuture<void> nestedTransactions() async {\n  await transaction(() async {\n    await into(categories).insert(CategoriesCompanion.insert(name: 'first'));\n    // this is a nested transaction:\n    await transaction(() async {\n      // At this point, the first category is visible\n      await into(\n        categories,\n      ).insert(CategoriesCompanion.insert(name: 'second'));\n      // Here, the second category is only visible inside this nested\n      // transaction.\n    });\n    // At this point, the second category is visible here as well.\n    try {\n      await transaction(() async {\n        // At this point, both categories are visible\n        await into(\n          categories,\n        ).insert(CategoriesCompanion.insert(name: 'third'));\n        // The third category is only visible here.\n        throw Exception('Abort in the second nested transaction');\n      });\n    } on Exception {\n      // We're catching the exception so that this transaction isn't reverted\n      // as well.\n    }\n    // At this point, the third category is NOT visible, but the other two\n    // are. The transaction is in the same state as before the second nested\n    // `transaction()` call.\n  });\n  // After the transaction, two categories are visible.\n}\n```\n### Supported implementations[#](https://drift.simonbinder.eu/dart_api/transactions#supported-implementations)\nNested transactions require support by the database implementation you're using with drift. All popular implementations support this feature, including:\n-   A `NativeDatabase` from `package:drift/native.dart`\n-   A `WasmDatabase` from `package:drift/wasm.dart`\n-   The sql.js-based `WebDatabase` from `package:drift/web.dart`\n-   A `SqfliteDatabase` from `package:drift_sqflite`.\nFurther, nested transactions are supported through remote database connections (e.g. isolates or web workers) if the server uses a database implementation that supports them.\n-   [](https://github.com/simolus3/drift)\n[](https://jaspr.site \"Built with the Jaspr web framework for Dart.\")\n©2019–2025Simon Binder, Drift authors. Documentation licensed under [CC0 1.0](https://creativecommons.org/publicdomain/zero/1.0/), Drift itself is [MIT-licensed](https://github.com/simolus3/drift/blob/develop/LICENSE)",
  "timestamp": 1769963767380,
  "title": "Transactions"
}