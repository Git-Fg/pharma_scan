{
  "url": "https://drift.simonbinder.eu/migrations",
  "markdown": "# Migrations\n[Drift](https://drift.simonbinder.eu/)\n-   [Docs](https://drift.simonbinder.eu/)\n-   [Guides](https://drift.simonbinder.eu/guides/datetime-migrations)\n-   [Examples](https://drift.simonbinder.eu/examples/)\n-   [pub.dev](https://pub.dev/packages/drift)\n-   [Docs](https://drift.simonbinder.eu/)\n    -   -   [Home](https://drift.simonbinder.eu/)\n        -   [Setup guide](https://drift.simonbinder.eu/setup)\n        -   [FAQ](https://drift.simonbinder.eu/faq)\n    -   Dart reference\n        -   [Defining tables](https://drift.simonbinder.eu/dart_api/tables)\n        -   [Selects](https://drift.simonbinder.eu/dart_api/select)\n        -   [Writes (update, insert, delete)](https://drift.simonbinder.eu/dart_api/writes)\n        -   [Expressions](https://drift.simonbinder.eu/dart_api/expressions)\n        -   [Stream queries](https://drift.simonbinder.eu/dart_api/streams)\n        -   [Schema introspection](https://drift.simonbinder.eu/dart_api/schema_inspection)\n        -   [Views](https://drift.simonbinder.eu/dart_api/views)\n        -   [DAOs](https://drift.simonbinder.eu/dart_api/daos)\n        -   [Manager API](https://drift.simonbinder.eu/dart_api/manager)\n        -   [Transactions](https://drift.simonbinder.eu/dart_api/transactions)\n    -   SQL API reference\n        -   [Overview](https://drift.simonbinder.eu/sql_api)\n        -   [Drift files](https://drift.simonbinder.eu/sql_api/drift_files)\n        -   [SQLite extensions](https://drift.simonbinder.eu/sql_api/extensions)\n        -   [Custom queries](https://drift.simonbinder.eu/sql_api/custom_queries)\n    -   Migrations\n        -   [Overview](https://drift.simonbinder.eu/migrations)\n        -   [Migrator APIs](https://drift.simonbinder.eu/migrations/api)\n        -   [Testing](https://drift.simonbinder.eu/migrations/tests)\n        -   [Helpers](https://drift.simonbinder.eu/migrations/step_by_step)\n        -   [Schema exports](https://drift.simonbinder.eu/migrations/exports)\n    -   Platforms\n        -   [Overview](https://drift.simonbinder.eu/platforms)\n        -   [Native](https://drift.simonbinder.eu/platforms/vm)\n        -   [Web](https://drift.simonbinder.eu/platforms/web)\n        -   [Encryption](https://drift.simonbinder.eu/platforms/encryption)\n        -   [libsql](https://drift.simonbinder.eu/platforms/libsql)\n        -   [PostgreSQL](https://drift.simonbinder.eu/platforms/postgres)\n    -   Generation options\n        -   [Overview](https://drift.simonbinder.eu/generation_options)\n        -   [Modular code generation](https://drift.simonbinder.eu/generation_options/modular)\n        -   [Drift and other builders](https://drift.simonbinder.eu/generation_options/in_other_builders)\n    -   Tools\n        -   [Overview](https://drift.simonbinder.eu/tools)\n        -   [Devtools extension](https://drift.simonbinder.eu/tools/devtools)\n        -   [Community tools](https://drift.simonbinder.eu/community_tools)\n    -   Advanced topics\n        -   [Isolates](https://drift.simonbinder.eu/isolates)\n        -   [Testing](https://drift.simonbinder.eu/testing)\n        -   [Generated table rows](https://drift.simonbinder.eu/dart_api/rows)\n        -   [Type converters](https://drift.simonbinder.eu/type_converters)\n        -   [Custom SQL types](https://drift.simonbinder.eu/sql_api/types)\n[Edit this page](https://github.com/simolus3/drift/edit/develop/docs/content/migrations/index.md) [Create documentation issue](https://github.com/simolus3/drift/issues/new?template=docs.md&title=Documentation+issue%3A+Migrations)\nOn this page[](# \"Top of the page\")\n-   [Guided Migrations](#guided-migrations)\n    -   [Configuration](#configuration)\n    -   [Usage](#usage)\n    -   [Switching to make-migrations](#switching-to-make-migrations)\n-   [During development](#during-development)\n-   [Manual Migrations](#manual-migrations)\n-   [Post-Migration callbacks](#post-migration-callbacks)\n# Migrations\nTooling and APIs to safely change the schema of your database.\nDrift ensures type-safe queries through a strict schema. To change this schema, you must write migrations. Drift provides a range of APIs, command-line tools, and testing utilities to make writing and verifying database migrations easier and more reliable.\n## Guided Migrations[#](https://drift.simonbinder.eu/migrations#guided-migrations)\nDrift provides built-in tools to help you write and test migrations. This enables you to write your schema changes incrementally, while test utilities give you confidence that your schema migrations are correct.\n### Configuration[#](https://drift.simonbinder.eu/migrations#configuration)\nTo use the `make-migrations` command, you must add the location of your database(s) to your `build.yaml` file.\n```\ntargets:\n  $default:\n    builders:\n      drift_dev:\n        options:\n          databases:\n            # Required: A name for the database and its path\n            my_database: lib/database.dart\n            # Optional: Add more databases\n            another_db: lib/database2.dart\n```\nYou can also optionally specify the directory where the test files and schema files are stored. Drift will generate multiple schema files, one for each version of your database schema. These files are used to compare the current schema with the previous schema and generate the migration code.\n```\ntargets:\n  $default:\n    builders:\n      drift_dev:\n        options:\n          # The directory where the test files are stored:\n          test_dir: test/drift/ # (default)\n          # The directory where the schema files are stored:\n          schema_dir: drift_schemas/  # (default)\n```\n### Usage[#](https://drift.simonbinder.eu/migrations#usage)\nBefore you start making changes to your initial database schema, run this command to generate the initial schema file.\n```\ndart run drift_dev make-migrations\n```\nOnce this initial schema file is saved, you can start making changes to your database schema.\nOnce you're happy with the changes, bump the `schemaVersion` in your database class and run the command again.\n```\ndart run drift_dev make-migrations\n```\nThis command will generate the following files:\n-   A step-by-step migration file will be generated next to your database class. Use this function to write your migrations incrementally. See the [step-by-step migration guide](https://drift.simonbinder.eu/migrations/step_by_step) for more information.\n-   Drift will also generate a test file for your migrations. After you've written your migration, run the tests to verify that your migrations are written correctly. This files will also contain a sample data integrity test for the first migration.\nIf you get stuck along the way, don't hesitate to [open a discussion about it](https://github.com/simolus3/drift/discussions).\n#### Example\nAfter you've changed the schema of your database and ran the `make-migrations` command, it's time to write a migration. If your database was defined in a `database.dart` file, Drift will have generated a `database.steps.dart` file next to it. That file will contain a compressed representation of all your schema versions going forward, which makes writing migrations much easier:\n```\nimport 'package:drift/drift.dart';\nimport 'database.steps.dart';\npart 'database.g.dart';\n@DriftDatabase(...)\nclass MyDatabase extends _$MyDatabase {\n  MyDatabase(super.e);\n  @override\n  int get schemaVersion => 2; // bump because the tables have changed.\n  @override\n  MigrationStrategy get migration {\n    return MigrationStrategy(\n      onUpgrade: _schemaUpgrade,\n    );\n  }\n}\nextension Migrations on GeneratedDatabase {\n  // Extracting the `stepByStep` call into a static field or method ensures that you're not\n  // accidentally referring to the current database schema (via a getter on the database class).\n  // This ensures that each step brings the database into the correct snapshot.\n  OnUpgrade get _schemaUpgrade => stepByStep(\n    from1To2: (m, schema) async {\n      await m.createTable(schema.groups);\n    },\n  );\n}\n```\nSee the [example](https://github.com/simolus3/drift/tree/develop/examples/migrations_example) in the drift repository for a complete example of how to use the `make-migrations` command.\n### Switching to `make-migrations`[#](https://drift.simonbinder.eu/migrations#switching-to-make-migrations)\nIf you've already been using the `schema` tools to write migrations, you can switch to `make-migrations` by following these steps:\n1.  Run the `make-migrations` command to generate the initial schema file.\n2.  Move all of your existing `schema` files into the schema directory for your database.\n3.  Run the `make-migrations` command again to generate the step-by-step migration file and test files.\n## During development[#](https://drift.simonbinder.eu/migrations#during-development)\nDuring development, you might be changing your schema very often and don't want to write migrations for that yet. You can just delete your apps' data and reinstall the app - the database will be deleted and all tables will be created again. Please note that uninstalling is not enough sometimes - Android might have backed up the database file and will re-create it when installing the app again.\nYou can also delete and re-create all tables every time your app is opened, see [this comment](https://github.com/simolus3/drift/issues/188#issuecomment-542682912) on how that can be achieved.\n## Manual Migrations[#](https://drift.simonbinder.eu/migrations#manual-migrations)\nManual migrations are error-prone\nWriting migrations manually is error-prone and can lead to data loss. We recommend using the `make-migrations` command to generate migrations and tests.\nDrift provides a migration API that can be used to gradually apply schema changes after bumping the `schemaVersion` getter inside the `Database` class. To use it, override the `migration` getter.\nHere's an example: Let's say you wanted to add a due date to your todo entries (`v2` of the schema). Later, you decide to also add a priority column (`v3` of the schema).\n```\nclass Todos extends Table {\n  IntColumn get id => integer().autoIncrement()();\n  TextColumn get title => text().withLength(min: 6, max: 10)();\n  TextColumn get content => text().named('body')();\n  IntColumn get category => integer().nullable()();\n  DateTimeColumn get dueDate =>\n      dateTime().nullable()(); // new, added column in v2\n  IntColumn get priority => integer().nullable()(); // new, added column in v3\n}\n```\nWe can now change the `database` class like this:\n```\n@override\nint get schemaVersion => 3; // bump because the tables have changed.\n@override\nMigrationStrategy get migration {\n  return MigrationStrategy(\n    onCreate: (Migrator m) async {\n      await m.createAll();\n    },\n    onUpgrade: (Migrator m, int from, int to) async {\n      if (from < 2) {\n        // we added the dueDate property in the change from version 1 to\n        // version 2\n        await m.addColumn(todos, todos.dueDate);\n      }\n      if (from < 3) {\n        // we added the priority property in the change from version 1 or 2\n        // to version 3\n        await m.addColumn(todos, todos.priority);\n      }\n    },\n  );\n}\n// The rest of the class can stay the same\n```\nYou can also add individual tables or drop them - see the reference of [Migrator](https://pub.dev/documentation/drift/latest/drift/Migrator-class.html) for all the available options.\nYou can also use higher-level query APIs like `select`, `update` or `delete` inside a migration callback. However, be aware that drift expects the latest schema when creating SQL statements or mapping results. For instance, when adding a new column to your database, you shouldn't run a `select` on that table before you've actually added the column. In general, try to avoid running queries in migration callbacks if possible.\n## Post-Migration callbacks[#](https://drift.simonbinder.eu/migrations#post-migration-callbacks)\nThe `beforeOpen` parameter in `MigrationStrategy` can be used to populate data after the database has been created. It runs after migrations, but before any other query. Note that it will be called whenever the database is opened, regardless of whether a migration actually ran or not. You can use `details.hadUpgrade` or `details.wasCreated` to check whether migrations were necessary:\n```\nbeforeOpen: (details) async {\n    if (details.wasCreated) {\n      final workId = await into(categories).insert(Category(description: 'Work'));\n      await into(todos).insert(TodoEntry(\n            content: 'A first todo entry',\n            category: null,\n            targetDate: DateTime.now(),\n      ));\n      await into(todos).insert(\n            TodoEntry(\n              content: 'Rework persistence code',\n              category: workId,\n              targetDate: DateTime.now().add(const Duration(days: 4)),\n      ));\n    }\n},\n```\nYou could also activate pragma statements that you need:\n```\nbeforeOpen: (details) async {\n  if (details.wasCreated) {\n    // ...\n  }\n  await customStatement('PRAGMA foreign_keys = ON');\n}\n```\n-   [](https://github.com/simolus3/drift)\n[](https://jaspr.site \"Built with the Jaspr web framework for Dart.\")\n©2019–2025Simon Binder, Drift authors. Documentation licensed under [CC0 1.0](https://creativecommons.org/publicdomain/zero/1.0/), Drift itself is [MIT-licensed](https://github.com/simolus3/drift/blob/develop/LICENSE)",
  "timestamp": 1769974120697,
  "title": "Migrations"
}