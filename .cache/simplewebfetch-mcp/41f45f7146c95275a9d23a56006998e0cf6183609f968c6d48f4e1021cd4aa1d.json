{
  "url": "https://drift.simonbinder.eu/testing",
  "markdown": "# Testing\n[Drift](https://drift.simonbinder.eu/)\n-   [Docs](https://drift.simonbinder.eu/)\n-   [Guides](https://drift.simonbinder.eu/guides/datetime-migrations)\n-   [Examples](https://drift.simonbinder.eu/examples/)\n-   [pub.dev](https://pub.dev/packages/drift)\n-   [Docs](https://drift.simonbinder.eu/)\n    -   -   [Home](https://drift.simonbinder.eu/)\n        -   [Setup guide](https://drift.simonbinder.eu/setup)\n        -   [FAQ](https://drift.simonbinder.eu/faq)\n    -   Dart reference\n        -   [Defining tables](https://drift.simonbinder.eu/dart_api/tables)\n        -   [Selects](https://drift.simonbinder.eu/dart_api/select)\n        -   [Writes (update, insert, delete)](https://drift.simonbinder.eu/dart_api/writes)\n        -   [Expressions](https://drift.simonbinder.eu/dart_api/expressions)\n        -   [Stream queries](https://drift.simonbinder.eu/dart_api/streams)\n        -   [Schema introspection](https://drift.simonbinder.eu/dart_api/schema_inspection)\n        -   [Views](https://drift.simonbinder.eu/dart_api/views)\n        -   [DAOs](https://drift.simonbinder.eu/dart_api/daos)\n        -   [Manager API](https://drift.simonbinder.eu/dart_api/manager)\n        -   [Transactions](https://drift.simonbinder.eu/dart_api/transactions)\n    -   SQL API reference\n        -   [Overview](https://drift.simonbinder.eu/sql_api)\n        -   [Drift files](https://drift.simonbinder.eu/sql_api/drift_files)\n        -   [SQLite extensions](https://drift.simonbinder.eu/sql_api/extensions)\n        -   [Custom queries](https://drift.simonbinder.eu/sql_api/custom_queries)\n    -   Migrations\n        -   [Overview](https://drift.simonbinder.eu/migrations)\n        -   [Migrator APIs](https://drift.simonbinder.eu/migrations/api)\n        -   [Testing](https://drift.simonbinder.eu/migrations/tests)\n        -   [Helpers](https://drift.simonbinder.eu/migrations/step_by_step)\n        -   [Schema exports](https://drift.simonbinder.eu/migrations/exports)\n    -   Platforms\n        -   [Overview](https://drift.simonbinder.eu/platforms)\n        -   [Native](https://drift.simonbinder.eu/platforms/vm)\n        -   [Web](https://drift.simonbinder.eu/platforms/web)\n        -   [Encryption](https://drift.simonbinder.eu/platforms/encryption)\n        -   [libsql](https://drift.simonbinder.eu/platforms/libsql)\n        -   [PostgreSQL](https://drift.simonbinder.eu/platforms/postgres)\n    -   Generation options\n        -   [Overview](https://drift.simonbinder.eu/generation_options)\n        -   [Modular code generation](https://drift.simonbinder.eu/generation_options/modular)\n        -   [Drift and other builders](https://drift.simonbinder.eu/generation_options/in_other_builders)\n    -   Tools\n        -   [Overview](https://drift.simonbinder.eu/tools)\n        -   [Devtools extension](https://drift.simonbinder.eu/tools/devtools)\n        -   [Community tools](https://drift.simonbinder.eu/community_tools)\n    -   Advanced topics\n        -   [Isolates](https://drift.simonbinder.eu/isolates)\n        -   [Testing](https://drift.simonbinder.eu/testing)\n        -   [Generated table rows](https://drift.simonbinder.eu/dart_api/rows)\n        -   [Type converters](https://drift.simonbinder.eu/type_converters)\n        -   [Custom SQL types](https://drift.simonbinder.eu/sql_api/types)\n[Edit this page](https://github.com/simolus3/drift/edit/develop/docs/content/testing.md) [Create documentation issue](https://github.com/simolus3/drift/issues/new?template=docs.md&title=Documentation+issue%3A+Testing)\nOn this page[](# \"Top of the page\")\n-   [Setup](#setup)\n-   [Writing tests](#writing-tests)\n-   [Testing migrations](#testing-migrations)\n# Testing\nGuide on writing unit tests for drift databases\nFlutter apps using drift can always be tested with [integration tests](https://flutter.dev/docs/cookbook/testing/integration/introduction) running on a real device. This guide focuses on writing unit tests for a database written in drift. Those tests can be run and debugged on your computer without additional setup, you don't need a physical device to run them.\n## Setup[#](https://drift.simonbinder.eu/testing#setup)\nFor this guide, we're going to test a very simple database that stores user names. The only important change from a regular drift database is the constructor: We make the `QueryExecutor` argument explicit instead of having a no-args constructor that passes a fixed executor (like a `FlutterQueryExecutor` or a `NativeDatabase`) to the superclass:\n```\nimport 'package:drift/drift.dart';\npart 'database.g.dart';\nclass Users extends Table {\n  IntColumn get id => integer().autoIncrement()();\n  TextColumn get name => text()();\n}\n@DriftDatabase(tables: [Users])\nclass MyDatabase extends _$MyDatabase {\n  MyDatabase(QueryExecutor e) : super(e);\n  @override\n  int get schemaVersion => 1;\n  /// Creates a user and returns their id\n  Future<int> createUser(String name) {\n    return into(users).insert(UsersCompanion.insert(name: name));\n  }\n  /// Changes the name of a user with the [id] to the [newName].\n  Future<void> updateName(int id, String newName) {\n    return update(users).replace(User(id: id, name: newName));\n  }\n  Stream<User> watchUserWithId(int id) {\n    return (select(users)..where((u) => u.id.equals(id))).watchSingle();\n  }\n}\n```\nInstalling sqlite\nWe can't distribute an sqlite installation as a pub package (at least not as something that works outside of a Flutter build), so you need to ensure that you have the sqlite3 shared library installed on your system.\nOn macOS, it's installed by default.\nOn Linux, you can use the `libsqlite3-dev` package on Ubuntu and the `sqlite3` package on Arch (other distros will have similar packages).\nOn Windows, you can [download 'Precompiled Binaries for Windows'](https://www.sqlite.org/download.html) and extract `sqlite3.dll` into a folder that's in your `PATH` environment variable. Then restart your device to ensure that all apps will run with this `PATH` change.\nAs `sqlite3_flutter_libs` bundles the latest sqlite3 version with your app, using a recent sqlite3 version is recommended to avoid differences in how tests behave from your app. The minimum sqlite version tested with drift is 3.29.0, but many drift features like `returning` or generated columns will require more recent versions.\n## Writing tests[#](https://drift.simonbinder.eu/testing#writing-tests)\nWe can create an in-memory version of the database by using a `NativeDatabase.memory()` instead of a `FlutterQueryExecutor` or other implementations. A good place to open the database is the `setUp` and `tearDown` methods from `package:test`:\n```\nimport 'package:drift/drift.dart';\nimport 'package:drift/native.dart';\nimport 'package:test/test.dart';\n// the file defined above, you can test any drift database of course\nimport 'database.dart';\nvoid main() {\n  late AppDatabase database;\n  setUp(() {\n    database = AppDatabase(\n      DatabaseConnection(\n        NativeDatabase.memory(),\n        // Recommended for widget tests to avoid test errors.\n        closeStreamsSynchronously: true,\n      ),\n    );\n  });\n  tearDown(() async {\n    await database.close();\n  });\n}\n```\nClosing streams synchronously\nBy default, unsubscribing from a query stream created by drift will keep the stream open for one event loop iteration. This is useful for e.g. Flutter apps, where rebuilds may cause a `StreamBuilder` to re-subscribe to streams frequently. In Flutter widget tests however, it's illegal to keep these timers open after a test concludes. To avoid issues with Drift in that setups, pass a `DatabaseConnection` with `closeStreamsSynchronously: true` to your database.\nWith that setup in place, we can finally write some tests:\n```\ntest('users can be created', () async {\n  final id = await database.createUser('some user');\n  final user = await database.watchUserWithId(id).first;\n  expect(user.name, 'some user');\n});\ntest('stream emits a new user when the name updates', () async {\n  final id = await database.createUser('first name');\n  final expectation = expectLater(\n    database.watchUserWithId(id).map((user) => user.name),\n    emitsInOrder(['first name', 'changed name']),\n  );\n  await database.updateName(id, 'changed name');\n  await expectation;\n});\n```\n## Testing migrations[#](https://drift.simonbinder.eu/testing#testing-migrations)\nDrift can help you generate code for schema migrations. For more details, see [this guide](https://drift.simonbinder.eu/migrations/tests).\n-   [](https://github.com/simolus3/drift)\n[](https://jaspr.site \"Built with the Jaspr web framework for Dart.\")\n©2019–2025Simon Binder, Drift authors. Documentation licensed under [CC0 1.0](https://creativecommons.org/publicdomain/zero/1.0/), Drift itself is [MIT-licensed](https://github.com/simolus3/drift/blob/develop/LICENSE)",
  "timestamp": 1769987714699,
  "title": "Testing"
}