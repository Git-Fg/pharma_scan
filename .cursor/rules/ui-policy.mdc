---
alwaysApply: true
description: 
globs: **/*
---

# Component Abstraction Policy (The "No-Wrapper" Rule)

**Source of truth:** The no-wrapper mandate is defined in `.cursor/rules/simplicity.mdc`. This file provides UI-specific guidance and examples for Shadcn usage.

## Core Mandate

**Do NOT create "Dumb Wrapper" widgets around Shadcn components.**

A "Dumb Wrapper" is a widget that:

1. Merely wraps a library widget (like `ShadButton` or `ShadCard`) with static padding/styling.
2. Has 0 business logic or state.
3. Requires "Passthrough Props" (arguments that are just passed down to the child).

## Examples

### ❌ FORBIDDEN (Dumb Wrapper)

```dart
// BAD: Hides the ShadCard API, requires maintenance for every new prop
class InfoCard extends StatelessWidget {
  final String title;
  final Widget child;
  const InfoCard({required this.title, required this.child});

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: EdgeInsets.all(16),
      child: ShadCard(title: Text(title), child: child),
    );
  }
}
```

### ✅ ALLOWED (Direct Usage + Theme/Helpers)

```dart
// GOOD: Full access to ShadCard API, obvious intent
Padding(
  padding: EdgeInsets.all(16),
  child: ShadCard(
    title: Text('My Title', style: context.shadTextTheme.h4),
    child: content,
  ),
)
```

## When to Abstract

Only create a new public widget in `core/widgets` if:

1. **Logic:** It contains conditional rendering logic (e.g., `RegulatoryBadges` checks 5 booleans).
2. **Composition:** It combines >3 distinct Shadcn components into a complex pattern (e.g., `ScannerResultCard` combines Card + Badges + Actions).
3. **State:** It manages internal ephemeral state (e.g., `SwipeBackDetector`).

## Styling Reuse Strategy

If you need to reuse **Styles**, use **Theme Extensions**, not Widgets.

```dart
// lib/core/theme/theme_extensions.dart
extension TypographyUtils on BuildContext {
  // Usage: Text('Label', style: context.mutedLabel)
  TextStyle get mutedLabel => shadTextTheme.small.copyWith(
    color: shadColors.mutedForeground,
    fontWeight: FontWeight.w600,
  );
}
```

## Scroll View Protocol

1. **Default to Simplicity:**
   - Use `SingleChildScrollView` + `Column` for static content (forms, settings, details).
   - Use `ListView.builder` for simple lists.

2. **Slivers (CustomScrollView) ONLY when:**
   - You need **Sticky Headers** (`SliverPersistentHeader`).
   - You need mixed scrollable content (Grid + List + Fixed Header).
   - You are dealing with massive datasets (>1000 items) requiring virtualization.

3. **SliverMainAxisGroup:**
   - **Restricted Usage:** Use ONLY when pairing a *Sticky Header* with its corresponding sliver list/grid.
   - **Forbidden:** Do not use it just to group code or add padding. Prefer helper builders that return `SliverList`/`SliverToBoxAdapter` directly.

## Dense Lists

- For dense collections (ex: génériques), prefer compact tiles (48–56px) that surface uniquement les facteurs différenciants (laboratoire, icônes d’état). Déplacez les détails complets dans un `ShadSheet` ouvert au tap.
- Évitez les cartes riches dans les listes serrées; gardez les rows plates et scannables.

## Mobile-First Shadcn Patterns

### 1. Sheet Protocol (The "Thumb Zone" Rule)

- **FORBIDDEN:** `ShadDialog` (except for simple Yes/No confirmations).
- **REQUIRED:** `ShadSheet` with `side: ShadSheetSide.bottom`.
- **Reasoning:** Bottom sheets handle keyboard insets better and are reachable with one hand.

### 2. Side Navigation (History/Menu)

- Use `ShadSheet` with `side: ShadSheetSide.left` for global navigation or history.
- Ensure a specific `close` button is accessible in the header for a11y.

### 3. Tappable Lists

- **Pattern:** Wrap list items in `ShadButton.raw(variant: ShadButtonVariant.ghost)`.
- **Constraint:** Minimum height 48px.
- **Why:** Provides native touch feedback and correct hit-testing area without extra `InkWell` widgets.

### 4. Critical Alerts

- **Embedded:** Place `ShadAlert` inside the content flow (e.g., top of a Card) for state awareness (Expired, No Stock).
- **Blocking:** Use `ShadDialog.alert` ONLY for destructive confirmation (Delete, Reset) with a Cancel `ShadButton.outline` and a confirm `ShadButton.destructive`. Example:

```dart
await showShadDialog<bool>(
  context: context,
  builder: (context) => ShadDialog.alert(
    title: const Text('Are you absolutely sure?'),
    description: const Padding(
      padding: EdgeInsets.only(bottom: 8),
      child: Text(
        'This action cannot be undone. This will permanently delete your account and remove your data from our servers.',
      ),
    ),
    actions: [
      ShadButton.outline(
        child: const Text('Cancel'),
        onPressed: () => Navigator.of(context).pop(false),
      ),
      ShadButton.destructive(
        child: const Text('Continue'),
        onPressed: () => Navigator.of(context).pop(true),
      ),
    ],
  ),
);
```

## Logic Isolation (Text & Highlighting)

**Mandate:** Do NOT reuse Data Layer sanitizers for UI rendering logic.

- **Data Layer Sanitizers:** Often perform aggressive normalization (trimming, collapsing whitespace, removing punctuation) to optimize index size. This changes string length and indices.
- **UI Logic:** Requires length-preserving normalization to map styling ranges (highlights) back to the original text.

**Rule:** If you are implementing `HighlightText` or similar widgets, write a local `_normalizePreservingLength` helper (e.g., `removeDiacritics(text).toLowerCase()`) inside the widget file. Never import `sanitizer.dart` for index calculations.
