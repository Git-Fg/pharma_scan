---
description: Drift database patterns, SQL-first logic, FTS5 search, and query optimization
globs: lib/core/database/**/*.dart, **/*.drift
alwaysApply: false
---

# Flutter Data Layer (2025 Standard)

## SQL-First Logic

**Mandate:** Can this logic (grouping, sorting, filtering) be done in a SQL View? If yes, use SQL.

- **SQL > Dart:** Never map/group rows in Dart if SQL View returns exact shape
- **Performance:** Views leverage SQLite optimizer
- **Reference:** See database views file for aggregated patterns

## Build Runner (2025 Reality)

- Dart Macros cancelled → `build_runner` is persistent standard
- Use `dart_mappable` ONLY for: Network DTOs, UI State
- **NEVER** for Database entities (use Extension Types wrapping Drift)

## Query Patterns

```
// ✅ Streams for UI data
@riverpod
Stream<List<Item>> items(Ref ref) {
  final dao = ref.watch(catalogDaoProvider);
  return dao.watchItems();
}

// ✅ watchSingleOrNull for detail views (handles deletion)
@riverpod
Stream<Item?> itemDetail(Ref ref, String id) {
  final dao = ref.watch(catalogDaoProvider);
  return dao.watchSingleOrNull(id);
}
```

## Optimization

- **Transactions:** Wrap multiple writes in `transaction(() async { ... })`
- **Batching:** Use `batch((batch) { ... })` for bulk inserts
- **Indexing:** Define indices in `.drift` files on `WHERE`/`JOIN` columns

## FTS5 Search

**FTS5 Native Tokenization:**

```
// Define in .drift file
CREATE VIRTUAL TABLE search_index USING fts5(
  content,
  tokenize='trigram'
);
```

**Normalization:**

- Use `normalize_text()` SQLite function (via `diacritic` package)
- Sanitize input: `escapeFts5Query()` before querying
- **Dart NEVER mutates strings** before hitting index

**Dependency:** Keep `sqlite3_flutter_libs` updated (verify trigram support)

## Database Safety

```
// ✅ watchSingleOrNull (prevents crashes on concurrent deletions)
Stream<Item?> watchItem(String id) => dao.watchSingleOrNull(id);

// ✅ .isIn handles large sets (Drift 2.24+, no manual chunking)
final query = db.select(db.table)..where((t) => t.id.isIn(ids));

// ❌ FORBIDDEN: String interpolation in queries
// ✅ Use Expression API for dynamic queries
```

## Drift Managers Mandate

**For bulk operations:** Push work into SQL views/inserts, let Drift generate APIs.

```
// ✅ SQL-side bulk operations
await database.deleteSearchIndex();
await database.insertSearchIndexFromSummary();

// ❌ FORBIDDEN: Dart loops with per-row customStatement
```

## Offline-First Architecture

- **Primary Source:** Local database (Drift) is source of truth
- **Sync:** Implement background sync for remote data when needed
- **Caching:** Use database as cache layer for network responses

## Anti-Patterns

- ❌ Dart loops for grouping/sorting (use SQL Views)
- ❌ String interpolation in queries (use Expression API)
- ❌ Manual chunking for `.isIn()` (Drift handles it)
- ❌ `watchSingle` (use `watchSingleOrNull`)
- ✅ SQL Views for aggregations
- ✅ Transactions for multi-write operations
- ✅ FTS5 with trigram tokenizer
