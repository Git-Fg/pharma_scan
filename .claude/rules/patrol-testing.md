---
paths:
  - "patrol_test/**/*"
  - "analysis_options.yaml"
---

# Patrol Testing Rules

## Auto-Generated Files

**NEVER EDIT** `patrol_test/test_bundle.dart`:
- Auto-generated by `patrol_cli` on every `patrol test` run
- Contains runtime-only imports that fail static analysis
- Manual changes are lost on regeneration

## Analysis Exclusion

`patrol_test/**` is excluded in `analysis_options.yaml`:

```yaml
analyzer:
  exclude:
    - "patrol_test/**"
```

**Why**: The auto-generated `test_bundle.dart` imports packages that only exist in Patrol's runtime environment (`patrol_tester.dart`, `executeTests()`). Excluding generated artifacts is standard practice.

## Import Rules

**DO** import in test files:
- `package:patrol/patrol.dart` (public API)
- `package:flutter_test/flutter_test.dart`
- Robot files from `../robots/`

**DON'T** import:
- `package:patrol/patrol_tester.dart` (runtime-only, CLI provides this)
- `package:patrol/patrol_tester.dart` (deprecated in Patrol 4.0)

**Patrol 4.x API Changes:**

Old (deprecated):
```dart
import 'package:patrol/patrol.dart';

// Using NativeAutomator
await $.native.tap(Selector(text: 'Allow'));
```

New (Patrol 4.0+):
```dart
import 'package:patrol/patrol.dart';

// Using PlatformAutomator
await $.native.tap(Selector(text: 'Allow'));
```

**Web Testing (Patrol 4.0+):**
```dart
import 'package:patrol/patrol.dart';

patrolTest('web test', ($) async {
  await $.web.enableDarkMode();
  await $.web.enterText('input', 'test@example.com');
  await $.web.tap('button#submit');
  await $.web.scrollTo('footer');
});
```

## Test File Structure

```dart
import 'package:patrol/patrol.dart';
import '../robots/app_robot.dart';

void main() {
  patrolTest('description', ($) async {
    final app = AppRobot($);
    await app.startApp();
    // test steps
  });
}
```

## Running Tests

```bash
# Primary development workflow - hot restart enabled
patrol develop --target patrol_test/tests/full_cycle_test.dart

# Run tests (replaces deprecated patrol test)
patrol test --target patrol_test/tests/full_cycle_test.dart

# With tags (Patrol 3.10+)
patrol test --tags smoke
patrol test --exclude-tags slow

# With coverage (Patrol 3.11+)
patrol test --coverage --coverage-packages lib/

# Web testing (Patrol 4.0+)
patrol test --target patrol_test/tests/web_test.dart --device chrome

# Incorrect - flutter test doesn't provide Patrol runtime
flutter test patrol_test/tests/full_cycle_test.dart
```

### Test Directory Configuration (Patrol 4.0+)

Configure custom test directory in `pubspec.yaml`:
```yaml
patrol:
  test_directory: patrol_test  # Default since Patrol 4.0
```

## Test Organization with Tags (Patrol 3.10+)

```dart
import 'package:patrol/patrol.dart';

@Tags(['smoke', 'regression'])
void main() {
  patrolTest('critical path', ($) async {
    // test code
  });
}
```

Run with tags:
```bash
patrol test --tags smoke                    # Run only smoke tests
patrol test --tags '(android || ios)'       # Platform-specific
patrol test --exclude-tags slow             # Exclude slow tests
```

## DevTools Extension (Patrol 3.0+)

Patrol includes a DevTools extension for debugging native view hierarchy:

```bash
patrol develop --target patrol_test/tests/my_test.dart
# Automatically opens DevTools with native view inspector
```

Disable auto-open:
```bash
patrol develop --no-open-devtools
```

## Key Files

| File | Purpose | Edit? |
|------|---------|-------|
| `test_bundle.dart` | Auto-generated entry point | **NO** |
| `tests/*.dart` | Test implementations | Yes |
| `robots/*.dart` | Page object robots | Yes |

## patrolWidgetTest vs patrolTest (Patrol 3.x+)

Use `patrolWidgetTest` for widget tests without native automation:
```dart
import 'package:patrol/patrol.dart';

patrolWidgetTest('widget test', ($) async {
  await $.pumpWidget(MyWidget());
  expect($(#title), findsOneWidget);
});
```

Use `patrolTest` for full native automation:
```dart
patrolTest('e2e test', ($) async {
  await $.pumpWidgetAndSettle(MyApp());
  await $.native.tap(Selector(text: 'Allow'));
});
```

## For Full Documentation

See skill: `/managing-tests` or `.claude/skills/managing-tests/SKILL.md`
