# PharmaScan Domain Model

## Overview

PharmaScan manages French pharmaceutical data from the **BDPM** (Base de Données Publique des Médicaments). This document explains the core data model and medication hierarchy.

---

## Core Identifiers

### CIP (Code Identifiant de Présentation)
- **Format**: 13-digit GTIN-13 barcode
- **Purpose**: Identifies a specific medication presentation (packaging)
- **Example**: `3400935955838` = DOLIPRANE 1000 mg, box of 30 tablets
- **Represents**: The scannable unit

### CIS (Code Identifiant de Spécialité)
- **Format**: 8-digit code
- **Purpose**: Identifies a pharmaceutical specialty (unique medication)
- **Example**: `61983278` = DOLIPRANE 1000 mg (all presentations)
- **Represents**: The medication formulation

**Relationship**: One CIS can have multiple CIPs (different package sizes).

---

## Medication Hierarchy

```
Cluster (Molecule/Combo)
  └── Group (Dosage/Form)
      └── CIS (Specialty)
          └── CIP (Presentation)
```

### Cluster (Molecule Level)
- **Definition**: Medications with identical chemical composition
- **Named by**: Active substance(s) + dosage
- **Example**: All amoxicillin medications cluster together
- **Purpose**: Groups products by therapeutic equivalence

### Group (Dosage/Form Level)
- **Definition**: Specific dosage and pharmaceutical form
- **Example**: ALDACTONE 50 mg vs ALDACTONE 75 mg
- **Contains**: Multiple CIS variants from different laboratories
- **Purpose**: Distinguishes strength and formulation differences

### CIS (Specialty Level)
- **Definition**: Individual medication specialty
- **Types**: Princeps (reference) or Generic
- **Constraint**: Belongs to exactly one group
- **Purpose**: Unique product identifier

### CIP (Presentation Level)
- **Definition**: Specific packaging/box
- **Multiple per CIS**: Different package sizes, quantities
- **Contains**: Pricing and barcode information
- **Purpose**: Scannable unit for scanner feature

---

## Equivalence Types

French pharmaceutical law defines four types of medication equivalence:

| Type | Name | Description |
|------|------|-------------|
| **0** | Princeps | Reference medication in a group |
| **1** | Generic | Same substance, dosage, and form as princeps |
| **2** | Posological | Different dosages, prescriber's choice |
| **3** | Complementary | Substitutable medications |

### Generic Equivalence (Type 1)
- **Definition**: Identical active substance, dosage, and form
- **Example**: DOLIPRANE 1000 mg ↔ generic paracetamol 1000 mg tablets
- **Substitutable**: Pharmacist can substitute automatically

### Posological Equivalence (Type 2)
- **Definition**: Different dosages, prescriber's choice
- **Example**: IBUPROFENE 400 mg ↔ IBUPROFENE 600 mg
- **Substitutable**: Only with prescriber authorization

---

## Princeps Election Logic

The system elects a princeps (reference medication) for each cluster using this priority:

1. **Active status**: Commercialized medications > Stopped medications
2. **Seniority**: Older medications (lower sort order) > Newer medications
3. **Fallback**: Group label if no active princeps exists

**Result**: The elected princeps becomes the cluster's canonical display name.

---

## Chemical ID

**Purpose**: Create a unique identifier for medication composition.

**Format**: Substance codes joined with `+`

```
Example: Amoxicillin + Clavulanic acid
ChemicalID = "0045+1234"

Example: Paracetamol alone
ChemicalID = "0123"
```

**Used for**: Clustering medications with identical active substances.

---

## Salt Normalization

**Purpose**: Remove salt prefixes/suffixes to normalize substance names.

**Examples**:
- `AMOXICILLINE TRIHYDRATE` → `AMOXICILLINE`
- `CHLORHYDRATE DE PROPRANOLOL` → `PROPRANOLOL`
- `HEMIFUMARATE D'ATOMOXETINE` → `ATOMOXETINE`

**Note**: This is where regex brittleness occurs (see `REGEX_BRITTLENESS.md`).

---

## Extension Types

**Purpose**: Provide type safety over primitives without runtime overhead.

**Examples**:
- `Cip13(int)` - 13-digit barcode
- `CisCode(int)` - 8-digit specialty code
- `ClusterId(String)` - Chemical cluster identifier
- `GroupId(int)` - Dosage/form group identifier

**Benefit**: Compile-time type safety prevents mixing incompatible identifiers.

---

## Database Architecture

### Dual SQLite
- **Reference Database**: BDPM data (read-only, generated by pipeline)
- **User Database**: Local data (restock, history, user preferences)

### Transparent Access
- Both databases attach transparently
- Queries can access data from both sources
- User data can reference reference data via foreign keys

### STRICT Tables
- All tables use `STRICT` keyword for type safety
- Enforces data types at database level
- Prevents schema drift

---

## Key BDPM Data Sources

| File | Purpose |
|------|---------|
| `CIS_bdpm.txt` | Master product definitions |
| `CIS_CIP_bdpm.txt` | Pricing and presentations |
| `CIS_GENER_bdpm.txt` | Generic groupings and equivalence |
| `CIS_COMPO_bdpm.txt` | Composition and dosages |
| `CIS_CPD_bdpm.txt` | Prescription conditions |
| `CIS_HAS_SMR_bdpm.txt` | Medical service evaluations |

---

## Form Prioritization: Pharmacy Drawers First

### Primary Focus (Tiroirs de pharmacie)

The system prioritizes medication forms commonly found in pharmacy drawers:

| Category | Forms | Examples |
|----------|-------|----------|
| **Oral Solids** | comprimé, gélule, lyophilisat | Clamoxyl gélule, Doliprane comprimé |
| **Oral Liquids** | sirop, suspension, solution | Augmentin sirop, Smecta suspension |
| **Ophthalmic** | collyre, pommade oculaire | Timoptol collyre |
| **ORL** | spray nasal, gouttes auriculaires | Rhinadvil spray, Cerumen gouttes |
| **Gynécologique** | ovule, crème vaginale | Flagyle ovule, Econazole crème |
| **Dermatologique** | crème, pommade, gel | Voltarène émulgel, Biafine crème |
| **Inhalation** | inhalateur, spray buccal | Ventoline inhalateur |

### Secondary Focus (Nice-to-have)

Less common or specialized forms that are useful but not primary:

| Category | Forms | Notes |
|----------|-------|-------|
| **Respiratory** | pastille, pastille pour la toux | Humex pastille, Drill pastille |
| **Other** | suppositoire, lavement | Useful but less common in drawers |

### Excluded / Lower Priority

Forms that are rarely in community pharmacy drawers:

| Category | Forms | Notes |
|----------|-------|-------|
| **Injectable** | solution injectable, poudre pour solution | Hospital/clinical use |
| **Perfusion** | soluté pour perfusion | Hospital use |
| **Radio** | solution radiopharmaceutique | Specialized facilities |
| **Veterinary** | spéciaux vétérinaires | Separate domain |

**Philosophy**: Optimize for what pharmacists scan daily. If it works for injectables or rare forms, that's a bonus - but the core system must be robust for common drawer items.

---

## Core Philosophical Principles

### 1. Single Source of Truth
- BDPM is the authoritative source
- Pipeline transforms but does not invent
- User data is separate from reference data

### 2. Therapeutic Equivalence First
- Cluster by chemical composition
- Princeps defines the reference
- Generics reference their princeps

### 3. Scan-Focused Design
- CIP is the primary user entry point
- Scanner drives the UX
- All data must be traceable to a scannable CIP

### 4. Type Safety
- Extension types prevent identifier confusion
- STRICT tables enforce schema
- Code generation ensures contract adherence
