name: Database Update

on:
  push:
    branches: [main]
  schedule:
    # Tous les lundis √† 3h00 du matin (UTC)
    - cron: "0 3 * * 1"
  workflow_dispatch: # Permet de lancer manuellement depuis l'interface GitHub

permissions:
  contents: write # N√©cessaire pour cr√©er la Release

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üçû Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: üì¶ Install dependencies
        run: cd backend_pipeline && bun install

      - name: ‚¨áÔ∏è Download Raw Data (ANSM)
        run: |
          cd backend_pipeline
          mkdir -p data
          bun run scripts/download_bdpm.ts -- --force

      - name: üöÄ Run ETL Pipeline
        run: cd backend_pipeline && bun run build
        env:
          DATA_DIR: ./data
          DB_PATH: ./data/reference.db

      - name: üóúÔ∏è Compress Database
        run: |
          cd backend_pipeline/data
          gzip -k -f reference.db
          ls -lh reference.db*

      - name: üè∑Ô∏è Generate Version Tag
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: üì¶ Create Release & Upload DB
        uses: softprops/action-gh-release@v1
        with:
          tag_name: db-${{ github.sha }}
          name: Database Update ${{ steps.date.outputs.date }}
          body: |
            Mise √† jour automatique de la base de donn√©es ANSM.
            Date : ${{ steps.date.outputs.date }}
            Commit : ${{ github.sha }}

            Cette release contient la base de donn√©es pr√©-g√©n√©r√©e `reference.db.gz` pour l'application PharmaScan.
          files: |
            backend_pipeline/data/reference.db.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
